<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://felipe-gomes-miyazato.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://felipe-gomes-miyazato.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2023-10-14T14:21:15+00:00</updated><id>https://felipe-gomes-miyazato.github.io/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">Pipelines de dados com monitoramento na AWS</title><link href="https://felipe-gomes-miyazato.github.io/blog/2023/aws-serverless-data-pipelines/" rel="alternate" type="text/html" title="Pipelines de dados com monitoramento na AWS"/><published>2023-09-30T00:00:00+00:00</published><updated>2023-09-30T00:00:00+00:00</updated><id>https://felipe-gomes-miyazato.github.io/blog/2023/aws-serverless-data-pipelines</id><content type="html" xml:base="https://felipe-gomes-miyazato.github.io/blog/2023/aws-serverless-data-pipelines/"><![CDATA[<p>Este post mostra como construir e viabilizar um bom gerenciamento de pipeline de dados utilizando serviços serverless da AWS.</p> <p>Requisitos:</p> <ul> <li>Conta AWS</li> </ul> <h2 id="parte-1-coletando-dados">Parte 1: Coletando dados</h2> <p>Demostração de contrução de uma função AWS Lambda que transfere dados de uma API pública para um bucket S3.</p> <h3 id="provisionando-lambda">Provisionando Lambda</h3> <p>Esta Lambda age apenas como uma proxy, para disponibilizar os dados em um bucket S3. Para provisionar bastam as configurações padrão, neste caso com Python runtime.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20200328-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20200328-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20200328-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20200328.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h3 id="código-e-configuração-da-lambda">Código e configuração da Lambda</h3> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">boto3</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">botocore.exceptions</span> <span class="kn">import</span> <span class="n">NoCredentialsError</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># URL da API pública "Public APIs"
</span>    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://api.publicapis.org/entries</span><span class="sh">"</span>

    <span class="c1"># Fazer a solicitação GET
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Verificar se a solicitação foi bem-sucedida
</span>    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="c1"># Salvar os dados em um arquivo JSON
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/tmp/public_apis.json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        
        <span class="c1"># Obter o nome do bucket do objeto do evento
</span>        <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">bucket_name</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># Criar um cliente S3
</span>        <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="sh">'</span><span class="s">s3</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># Fazer upload do arquivo para S3
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">s3</span><span class="p">.</span><span class="nf">upload_file</span><span class="p">(</span><span class="sh">"</span><span class="s">/tmp/public_apis.json</span><span class="sh">"</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">public_apis.json</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">statusCode</span><span class="sh">'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">body</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Conjunto de dados carregado com sucesso no bucket S3</span><span class="sh">'</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">statusCode</span><span class="sh">'</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">body</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">O arquivo não foi encontrado</span><span class="sh">'</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">NoCredentialsError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">statusCode</span><span class="sh">'</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">body</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Credenciais não disponíveis</span><span class="sh">'</span>
            <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">statusCode</span><span class="sh">'</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">body</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Solicitação falhou</span><span class="sh">'</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure> <h3 id="evento-gatilho">Evento gatilho</h3> <p>Configurar o evento de teste com o JSON:</p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"bucket_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"seu-nome-bucket"</span><span class="w">
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-09-30%20143901-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-09-30%20143901-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-09-30%20143901-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-09-30%20143901.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para usar o pacote requests, há uma <a href="https://github.com/keithrozario/Klayers/tree/master">layer pública disponível</a>. </div> <h3 id="permissionamento-da-lambda">Permissionamento da Lambda</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201151-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201151-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201151-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20201151.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para autorizar a lambda a inputar objetos no bucket é necessário acessar a configuração da role. </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201325-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201325-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201325-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20201325.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Em seguida, acessar a configuração <mark>Add permissions</mark> &gt; <mark>Attach policies</mark>. </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201511-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201511-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20201511-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20201511.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Neste case, será adicionada a política <b>AmazonS3FullAccess</b>. </div> <h3 id="criar-um-bucket-no-amazon-s3">Criar um bucket no Amazon S3</h3> <p><a href="https://s3.console.aws.amazon.com/s3/get-started">https://s3.console.aws.amazon.com/s3/get-started</a></p> <h3 id="configurar-o-bucket">Configurar o bucket</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-09-30%20212902-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-09-30%20212902-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-09-30%20212902-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-09-30%20212902.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para este case, as configurações padrão funcionam. </div> <h3 id="permissionamento-do-bucket">Permissionamento do bucket</h3> <p>Para configurar permissões de acesso para que um bucket do Amazon S3 seja público (somente leitura), pode-se seguir estas etapas:</p> <ol> <li>Abrir o console do Amazon S3.</li> <li>No painel de navegação do Buckets, escolher o nome do seu bucket.</li> <li>Escolher a guia “Permissões”.</li> <li>Retirar o bloqueio de acesso público</li> <li>Em “Gerenciamento de acesso ao bucket”, escolher “Editar”.</li> <li>Em “Política de bucket”, inserir a seguinte política, substituindo <code class="language-plaintext highlighter-rouge">'your_bucket_name'</code>:</li> </ol> <figure class="highlight"><pre><code class="language-json" data-lang="json"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="w">    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Version"</span><span class="p">:</span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Statement"</span><span class="p">:[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"Sid"</span><span class="p">:</span><span class="s2">"PublicReadGetObject"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"Effect"</span><span class="p">:</span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"Action"</span><span class="p">:[</span><span class="s2">"s3:GetObject"</span><span class="p">],</span><span class="w">
          </span><span class="nl">"Resource"</span><span class="p">:[</span><span class="s2">"arn:aws:s3:::your_bucket_name/*"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure> <p>Essa política permite que qualquer pessoa leia os objetos no bucket.</p> <h2 id="parte-2-pipeline-de-dados">Parte 2: Pipeline de Dados</h2> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20111047-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20111047-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20111047-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20111047.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para esta parte é necessário configurar em <mark>Set up roles and users</mark>. </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20111330-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20111330-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20111330-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20111330.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Marcar <b>Read and write</b> em <mark><b>Data access permissions</b></mark> e as outras configurações deixar no padrão. </div> <h3 id="criar-bucket-de-dados-processados">Criar bucket de dados processados</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20105420-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20105420-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20105420-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20105420.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h3 id="criar-um-job-no-aws-glue">Criar um job no AWS Glue</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20105928-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20105928-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20105928-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20105928.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para deixar o exemplo menos exaustivo, utilizar <b>Python Shell script editor</b> para criar o job. </div> <h3 id="catalogar-com-crawler">Catalogar com crawler</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20202812-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20202812-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20202812-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20202812.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Configurações. </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20205915-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20205915-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20205915-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20205915.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Após rodar o crawler já é possível acessar a catalogação. </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20210105-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20210105-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20210105-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20210105.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> E dar uma boa espiada na estrutura dos dados. </div> <h3 id="desenvolver-etl">Desenvolver ETL</h3> <p>Segue um exemplo minimalista de script de ETL em Python, que quebra 50% das vezes para ajudar a explorar as ferramentas de monitoramento na Parte 3.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">boto3</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">random</span>

<span class="c1"># 50% breaks
</span><span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">Random exception</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Initialize boto3 client
</span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="sh">'</span><span class="s">s3</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_from_s3</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="p">.</span><span class="nf">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">Body</span><span class="sh">'</span><span class="p">].</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_to_s3</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">s3</span><span class="p">.</span><span class="nf">put_object</span><span class="p">(</span><span class="n">Body</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">input_bucket_name</span><span class="p">,</span> <span class="n">output_bucket_name</span><span class="p">,</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">output_key</span><span class="p">):</span>
    <span class="c1"># Read JSON from S3
</span>    <span class="n">data</span> <span class="o">=</span> <span class="nf">read_from_s3</span><span class="p">(</span><span class="n">input_bucket_name</span><span class="p">,</span> <span class="n">input_key</span><span class="p">)</span>

    <span class="c1"># Serialize the content from key "entries" in a dataframe
</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">entries</span><span class="sh">'</span><span class="p">])</span>

    <span class="n">description</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">describe</span><span class="p">().</span><span class="nf">to_csv</span><span class="p">()</span>
    <span class="nf">write_to_s3</span><span class="p">(</span><span class="n">output_bucket_name</span><span class="p">,</span> <span class="n">output_key</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

<span class="c1"># Call the function with your bucket name and keys
</span><span class="nf">process_data</span><span class="p">(</span><span class="sh">'</span><span class="s">felipe-gomes-miyazato-bucket</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dlakeanalytics</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">public_apis.json</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">describe_public_apis.csv</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure> <h2 id="parte-3-monitoramento">Parte 3: Monitoramento</h2> <h3 id="cloudwatch-dashboards">CloudWatch Dashboards</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20215426-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20215426-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20215426-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20215426.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Usar a ferramenta de dashboards nativa do CoudWatch para monitoria. </div> <h3 id="monitorar-função-lambda">Monitorar função lambda</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20215709-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20215709-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20215709-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20215709.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Adicionar widget de tabela de logs, configurada com o grupo de logs da lambda. </div> <h3 id="monitorar-erros-nos-jobs-do-glue">Monitorar erros nos jobs do Glue</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20220104-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20220104-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20220104-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20220104.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Adicionar widget de tabela de logs, configurada com o grupo de logs de erros do Glue. </div> <h3 id="ativar-o-amazon-cloudtrail">Ativar o Amazon CloudTrail</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20221405-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20221405-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20221405-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20221405.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para habilitar persistência dos logs crie uma Trail. </div> <h3 id="configurar-o-cloudtrail">Configurar o CloudTrail</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20222218-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20222218-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/Captura%20de%20tela%202023-10-01%20222218-1400.webp"/> <img src="/assets/img/Captura%20de%20tela%202023-10-01%20222218.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Para cada grupo de log que seja necessária a persistência crie uma Trail e configure com o grupo. </div>]]></content><author><name></name></author><category term="pt-br"/><category term="ETL"/><category term="serverless"/><category term="dados"/><category term="monitoramento"/><category term="AWS"/><summary type="html"><![CDATA[um exemplo não exaustivo de implementação de processo de ingestão de dados]]></summary></entry></feed>